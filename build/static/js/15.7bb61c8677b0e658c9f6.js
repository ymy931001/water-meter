webpackJsonp([15],{pYh8:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r("a5VY"),i=r("BlC7"),n=(r("IcnI"),{components:{selectAddress:o.a,QR:i.a},props:{},data:function(){return{collectorid:"",options:[],area:"请选择位置",form:{id:"",houseNumber:"",address:"",name:"",village:"",number:"",provinceId:"",cityId:"",istrictId:"",log:"",lat:""},rules:{id:[{required:!0,message:"请输入编号",trigger:"blur"}],size:[{required:!0,message:"请输入规格",trigger:"change"}],area:[{required:!0,message:"请选择地区"}],village:[{required:!0,message:"请输入小区",trigger:"change"}],address:[{required:!0,message:"请填写详细地址",trigger:"change"}],houseNumber:[{required:!0,message:"请输入门牌号",trigger:"change"}]}}},computed:{qrId:function(){return console.log(this.$store.state.qrId),this.$store.state.qrId}},watch:{qrId:function(e,t){this.form.id=e}},methods:{showMore:function(){this.$refs.collectorMore.classList.toggle("ishow")},getfocus:function(){this.$refs.select.$children[0].$el.childNodes[1].focus()},getVillage:function(){var e=this;null!==this.form.istrictId&&this.$http.get("/weiXin/api/v1/common/getAreaByPid",{id:this.form.istrictId}).then(function(t){t&&(e.options=t.data.data.map(function(e){return{value:e.district,label:e.district}}))})},getmaparea:function(){var e=this,t=new BMap.Geolocation,r=new BMap.Geocoder;t.enableSDKLocation(),t.getCurrentPosition(function(t){if(this.getStatus()==BMAP_STATUS_SUCCESS){new BMap.Marker(t.point),new BMap.Point(t.point.lng,t.point.lat);e.form.lat=t.point.lat,e.form.log=t.point.lng,r.getLocation(new BMap.Point(t.point.lng,t.point.lat),function(t){t&&(e.area=t.addressComponents.province+"-"+t.addressComponents.city+"-"+t.addressComponents.district,e.$http.get("/weiXin/api/v1/common/getIdsByDistrict",{province:t.addressComponents.province,city:t.addressComponents.city.substring(0,t.addressComponents.city.length-1),district:t.addressComponents.district.substring(0,t.addressComponents.district.length-1)}).then(function(t){t&&0==t.data.code?(e.form.provinceId=t.data.data[0].id,e.form.cityId=t.data.data[1].id,e.form.istrictId=t.data.data[2].id,e.getVillage()):(e.form.area="请选择地区",e.$message({type:"error",message:"定位失败,请手动选择省市区地址"}))}),e.form.area=t.addressComponents.province+"-"+t.addressComponents.city+"-"+t.addressComponents.district,e.form.address=t.addressComponents.street+"-"+t.addressComponents.streetNumber)})}else alert("failed"+this.getStatus())})},showdata:function(){var e=this;this.$http.get("/weiXin/api/v1/deviceMend/getReplaceDeviceInstallInfo",{deviceNum:this.collectorid}).then(function(t){var r=t.data.data;t&&(e.form={id:"",village:r.districtSite,houseNumber:r.houseNumber,lat:r.latitude,log:r.longitude,name:r.consumerUname,number:r.telephone,address:r.districtDetail,provinceId:r.provinceId,cityId:r.cityId,istrictId:r.districtId})}).then(function(){e.getVillage()})},slctAddress:function(){this.$refs.slcAdress.show()},reshowarea:function(e){e&&(this.area=e.join("-"))},areaConfirm:function(e){var t=this,r=e.map(function(e,t){return e.part});this.$nextTick(function(){t.area=r.join("-")});var o=e.map(function(e,t){if(e.id>0)return e});this.form.provinceId=o[0]&&o[0].id,this.form.cityId=o[1]&&o[1].id,this.form.istrictId=o[2]&&o[2].id,this.getVillage()},onSubmit:function(e){var t=this;this.$refs[e].validate(function(e){if(!e)return console.log("error submit!!"),!1;t.$confirm(3==t.$route.query.type?"是否替换该设备？":"是否进行测试？","提示",{showConfirmButton:3!=t.$route.query.type,confirmButtonText:"联网测试",cancelButtonText:"替换并安装",type:"warning",center:!0,distinguishCancelAndClose:!0,closeOnClickModal:!0,beforeClose:function(e,r,o){"confirm"===e?(r.confirmButtonLoading=!0,r.confirmButtonText="执行中...",t.$http.post("/weiXin/api/v1/deviceMend/replaceDevice",{deviceNumber:t.form.id,houseNumber:t.form.houseNumber,longitude:t.form.log,latitude:t.form.lat,districtSite:t.form.village,districtDetail:t.form.address,provinceId:t.form.provinceId,cityId:t.form.cityId,districtId:t.form.istrictId,consumerUname:t.form.name,telephone:t.form.number,deviceNum:t.collectorid}).then(function(e){e?t.$http.post("/weiXin/api/v1/deviceManager/networkingTest",{deviceNums:[t.form.id],deviceType:t.$route.query.type},{"Content-Type":"application/json; charset=UTF-8"},!0).then(function(e){e?setTimeout(function(){r.confirmButtonLoading=!1,r.confirmButtonText="联网测试",o(),t.$message({type:"success",message:"替换成功，联网测试已下发"})},300):(r.confirmButtonLoading=!1,r.confirmButtonText="联网测试")}):(r.confirmButtonLoading=!1,r.confirmButtonText="联网测试")})):"cancel"===e?t.$http.post("/weiXin/api/v1/deviceMend/replaceDevice",{deviceNumber:t.form.id,houseNumber:t.form.houseNumber,longitude:t.form.log,latitude:t.form.lat,districtSite:t.form.village,districtDetail:t.form.address,provinceId:t.form.provinceId,cityId:t.form.cityId,districtId:t.form.istrictId,consumerUname:t.form.name,telephone:t.form.number,deviceNum:t.collectorid}).then(function(e){e&&(t.$message({type:"success",message:"替换成功"}),o())}).catch(function(e){console.log(e)}):o()}}).then(function(e){t.$router.push("/textonline")}).catch(function(e){})})}},created:function(){this.getmaparea()},mounted:function(){null!==this.$route.query.collectorId&&(this.collectorid=this.$route.query.collectorId,this.showdata())}}),s={render:function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"replace"}},[r("el-form",{ref:"form",staticClass:"textform",attrs:{model:e.form,"label-width":"95px",rules:e.rules}},[r("el-form-item",{attrs:{label:"新设备编号",prop:"id"}},[r("el-input",{model:{value:e.form.id,callback:function(t){e.$set(e.form,"id",t)},expression:"form.id"}}),e._v(" "),r("QR")],1),e._v(" "),r("el-form-item",{staticClass:"location",attrs:{label:"详细地址",prop:"address"}},[r("el-input",{attrs:{placeholder:"街道/单元"},model:{value:e.form.address,callback:function(t){e.$set(e.form,"address",t)},expression:"form.address"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"具体位置",prop:"houseNumber"}},[r("el-input",{attrs:{placeholder:"例：一单元天台"},model:{value:e.form.houseNumber,callback:function(t){e.$set(e.form,"houseNumber",t)},expression:"form.houseNumber"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"安装地区"}},[r("span",{staticClass:"seletArea",attrs:{prop:"area"},on:{click:function(t){t.stopPropagation(),e.slctAddress(t)}}},[e._v(e._s(e.area))])]),e._v(" "),r("el-form-item",{attrs:{label:"所属小区",prop:"village"}},[r("el-select",{ref:"select",staticClass:"selectVillage",attrs:{filterable:"",remote:"","allow-create":"",clearable:"",placeholder:"XX小区"},nativeOn:{touchstart:function(t){e.getfocus()}},model:{value:e.form.village,callback:function(t){e.$set(e.form,"village",t)},expression:"form.village"}},e._l(e.options,function(e){return r("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),r("el-form-item",[r("el-button",{attrs:{type:"primary"},on:{click:function(t){e.onSubmit("form")}}},[e._v("替换")])],1),e._v(" "),r("el-button",{staticClass:"showMore",attrs:{type:"text"},on:{click:e.showMore}},[e._v("更多信息"),r("i",{staticClass:"el-icon-arrow-right"})]),e._v(" "),r("div",{ref:"collectorMore",staticClass:"collectorMore"},[r("el-form-item",{attrs:{label:"用户姓名",p:""}},[r("el-input",{model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"联系电话"}},[r("el-input",{model:{value:e.form.number,callback:function(t){e.$set(e.form,"number",t)},expression:"form.number"}})],1)],1)],1),e._v(" "),r("selectAddress",{ref:"slcAdress",attrs:{areaID:{pId:e.form.provinceId,cId:e.form.cityId,iId:e.form.istrictId}},on:{reshowarea:e.reshowarea,areaConfirm:e.areaConfirm}})],1)},staticRenderFns:[]};var a=r("46Yf")(n,s,!1,function(e){r("zaOq")},null,null);t.default=a.exports},zaOq:function(e,t){}});
//# sourceMappingURL=15.7bb61c8677b0e658c9f6.js.map
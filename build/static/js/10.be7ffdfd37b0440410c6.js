webpackJsonp([10],{"/K7l":function(e,t){},L0SJ:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=i("Dd8w"),n=i.n(o),r=i("jkKj"),s=i.n(r),a=i("a5VY"),l=i("//Fk"),c=i.n(l),d=i("Gu7T"),u=i.n(d),f=i("GQaK"),m=i("162o"),p=i("qn9g"),h={components:{},props:{deviceNum:{type:String}},data:function(){return{history:[],pageNum:1,historyScroll:!1,isEnd:!1,collector:{},isOffline:!1}},watch:{},computed:{},methods:{initScroll:function(e,t){var i=this;e?e.refresh():(e=new f.default(t,{eventPassthrough:"horizontal",pullUpLoad:!0})).on("pullingUp",function(){i.pageNum++,i.getResult().then(function(t){var o;0==t.length&&(i.isEnd=!0),(o=i.history).push.apply(o,u()(t)),e.finishPullUp(),e.refresh()})})},show:function(e){var t=this;this.collector=e,this.pageNum=1,this.isEnd=!1,this.getResult().then(function(e){t.history=e,Object(m.setTimeout)(function(){t.initScroll(t.historyScroll,t.$refs.wrapperDetail)},350)})},getResult:function(e){var t=this;return new c.a(function(e){t.isEnd||t.$http.get("/weiXin/api/v1/historyReading/getHistoryReading",{deviceNum:t.deviceNum,pageNum:t.pageNum,pageSize:10}).then(function(i){i&&(t.$el.style.setProperty("height","100vh"),e(i.data.data))})})},install:function(){var e,t=this;1==this.collector.type?e="singlemeter":2==this.collector.type&&(e="collector"),this.isOffline?Object(p.b)(e,data):this.$http.post("/weiXin/api/v1/deviceManager/collectorAndWirelessInstall",n()({},this.collector)).then(function(e){e?t.$http.post("/weiXin/api/v1/deviceManager/networkingTest",{deviceNums:[t.collector.deviceNumber],deviceType:t.collector.type},{"Content-Type":"application/json; charset=UTF-8"},!0).then(function(e){e?(t.$message({type:"success",message:t.collector.deviceNumber+"联网测试已下发"}),t.$el.style.setProperty("height",0),t.$router.push("/textonline")):t.$message({type:"error",message:"设备安装成功，联网测试下发失败"})}):(t.$message({type:"error",message:e.data.message}),t.$el.style.setProperty("height",0),t.$router.push("/textonline"))}).catch(function(t){"timeout"==t&&Object(p.b)(e,data)})}},created:function(){},mounted:function(){var e=this,t=function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i};t(window,"online",function(){e.isOffline=!1}),t(window,"offline",function(){e.isOffline=!0})}},g={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"testResult"},[i("div",{ref:"wrapperDetail",staticClass:"wrapper"},[i("div",[i("el-table",{staticClass:"searchResult",attrs:{size:"mini",border:"",data:e.history}},[i("el-table-column",{attrs:{fixed:"",prop:"date",label:"读数时间"}}),e._v(" "),i("el-table-column",{attrs:{prop:"voltage",label:"电压"}}),e._v(" "),i("el-table-column",{attrs:{prop:"signalIntensity",label:"信号强度"}})],1)],1)]),e._v(" "),i("div",{staticClass:"hisOption"},[i("el-button",{on:{click:function(t){e.$el.style.setProperty("height",0)}}},[e._v("取消安装")]),e._v(" "),i("el-button",{attrs:{type:"primary"},on:{click:e.install}},[e._v("确定安装")])],1)])},staticRenderFns:[]};var v=i("VU/8")(h,g,!1,function(e){i("puVE")},null,null).exports,b=i("BlC7"),y=(i("IcnI"),{mounted:function(){this.getmaparea();var e=function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},t=this;e(window,"online",function(){t.isOffline=!1,console.log("online:",t.isOffline)}),e(window,"offline",function(){t.isOffline=!0,console.log("offline:",t.isOffline)})},computed:{qrId:function(){return this.$store.state.qrId}},watch:{qrId:function(e){this.form.id=e}},data:function(){return{options:[],isOffline:!1,type:null,form:{id:"",wid:null,address:null,name:null,village:null,phoneNumber:null,doorNumber:null,type:[],provinceId:null,area:"请选择位置",cityId:null,istrictId:null,lat:null,lng:null},rules:{id:[{required:!0,message:"请输入编号",trigger:"blur"}],area:[{required:!0}],village:[{required:!0,message:"请输入小区",trigger:"change"}],address:[{required:!0,message:"请填写详细地址",trigger:"change"}],doorNumber:[{required:!0,message:"请填写具体位置",trigger:"blur"}]}}},methods:{showMore:function(){this.$refs.collectorMore.classList.toggle("ishow")},getVillage:function(){var e=this;this.$http.get("/weiXin/api/v1/common/getAreaByPid",{id:this.form.istrictId}).then(function(t){t&&(e.options=t.data.data.map(function(e){return{value:e.district,label:e.district}}))})},querySearch:function(e,t){var i=this.options;t(e?i.filter(this.createFilter(e)):i)},createFilter:function(e){return function(t){return 0===t.value.toLowerCase().indexOf(e.toLowerCase())}},getmaparea:function(){var e=this,t=new s.a.Geolocation,i=new s.a.Geocoder;t.enableSDKLocation(),t.getCurrentPosition(function(t){if(this.getStatus()==BMAP_STATUS_SUCCESS){new s.a.Marker(t.point),new s.a.Point(t.point.lng,t.point.lat);e.form.lat=t.point.lat,e.form.lng=t.point.lng,i.getLocation(new s.a.Point(t.point.lng,t.point.lat),function(t){t&&(e.area=t.addressComponents.province+"-"+t.addressComponents.city+"-"+t.addressComponents.district,e.$http.get("/weiXin/api/v1/common/getIdsByDistrict",{province:t.addressComponents.province,city:t.addressComponents.city.substring(0,t.addressComponents.city.length-1),district:t.addressComponents.district.substring(0,t.addressComponents.district.length-1)}).then(function(t){t&&0==t.data.code?(e.form.provinceId=t.data.data[0].id,e.form.cityId=t.data.data[1].id,e.form.istrictId=t.data.data[2].id,e.getVillage()):(e.form.area="请选择地区",e.$message({type:"error",message:"定位失败,请手动选择省市区地址"}))}),e.form.area=t.addressComponents.province+"-"+t.addressComponents.city+"-"+t.addressComponents.district,e.form.address=t.addressComponents.street+"-"+t.addressComponents.streetNumber)})}else alert("failed"+this.getStatus())})},areaConfirm:function(e){var t=this,i=e.map(function(e,t){return e.part});this.$nextTick(function(){t.form.area=i.join("-")});e.map(function(e,t){if(e.id>0)return e});this.form.provinceId=e[0]&&e[0].id,this.form.cityId=e[1]&&e[1].id,this.form.istrictId=e[2]&&e[2].id,this.getVillage()},slctAddress:function(){this.$refs.slcAdress.show()},onSubmit:function(e){var t,i=this,o=this,r={type:this.type,deviceNumber:this.form.id,longitude:this.form.lng,districtSite:this.form.village,districtDetail:this.form.address,latitude:this.form.lat,provinceId:this.form.provinceId,cityId:this.form.cityId,districtId:this.form.istrictId,associatedNum:this.form.wid,consumerUname:this.form.name,telephone:this.form.phoneNumber,houseNumber:this.form.doorNumber};this.$refs[e].validate(function(e){if(!e)return console.log("error submit!!"),!1;1==o.type?t="singlemeter":2==o.type&&(t="collector"),i.$confirm("是否进行测试？","提示",{confirmButtonText:"联网测试",cancelButtonText:"仅提交",type:"warning",center:!0,distinguishCancelAndClose:!0,closeOnClickModal:!0,beforeClose:function(e,s,a){"confirm"===e?(console.log(i.isOffline,o.isOffline),i.isOffline?(Object(p.b)(t,r),a()):(2==i.$route.query.type&&(i.$refs.testResult.show(r),a()),1==i.$route.query.type&&i.$http.post("/weiXin/api/v1/deviceManager/collectorAndWirelessInstall",n()({},r)).then(function(e){e?o.$http.post("/weiXin/api/v1/deviceManager/networkingTest",{deviceNums:[o.form.id],deviceType:i.type},{"Content-Type":"application/json; charset=UTF-8"},!0).then(function(e){e?(s.confirmButtonLoading=!1,s.confirmButtonText="联网测试",a(),o.$message({type:"success",message:o.form.id+"联网测试已下发"}),i.$router.push("/textonline")):(o.$message({type:"error",message:"设备安装成功，联网测试下发失败"}),s.confirmButtonLoading=!1,s.confirmButtonText="联网测试")}):setTimeout(function(){s.confirmButtonLoading=!1,s.confirmButtonText="联网测试",o.$message({type:"error",message:e.data.message})},300)}).catch(function(e){"timeout"==e&&(Object(p.b)(t,r),s.confirmButtonLoading=!1,s.confirmButtonText="联网测试",a())}))):"cancel"===e?o.isOffline?(Object(p.b)(t,r),a()):i.$http.post("/weiXin/api/v1/deviceManager/collectorAndWirelessInstall",n()({},r)).then(function(e){e?(Object(p.c)(t,i.form.id),a(),i.$message({type:"success",message:i.form.id+"安装成功"})):i.$message({type:"error",message:e.data.message})}).catch(function(e){console.log(e)}):(a(),s.confirmButtonLoading=!1,s.confirmButtonText="联网测试")}}).then(function(e){}).catch(function(e){})})}},components:{selectAddress:a.a,QR:b.a,testResult:v},activated:function(){null!==this.$route.query.type&&(this.type=this.$route.query.type),this.form.id&&this.form.id.length>6&&this.$store.commit("changeId",this.form.id.substring(0,6))}}),w={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"collector"}},[i("el-form",{ref:"form",staticClass:"textform",attrs:{model:e.form,"label-width":"80px",rules:e.rules}},[i("el-form-item",{staticClass:"location",attrs:{label:"详细地址",prop:"address"}},[i("el-input",{attrs:{placeholder:"门牌号、小区、楼栋号",clearable:""},model:{value:e.form.address,callback:function(t){e.$set(e.form,"address",t)},expression:"form.address"}})],1),e._v(" "),i("el-form-item",{attrs:{label:"所属小区",prop:"village"}},[i("el-autocomplete",{staticClass:"selectVillage",attrs:{"fetch-suggestions":e.querySearch,placeholder:"XX小区",clearable:""},model:{value:e.form.village,callback:function(t){e.$set(e.form,"village",t)},expression:"form.village"}})],1),e._v(" "),i("el-form-item",{attrs:{label:"具体位置",prop:"doorNumber"}},[i("el-input",{attrs:{placeholder:"一单元天台",clearable:""},model:{value:e.form.doorNumber,callback:function(t){e.$set(e.form,"doorNumber",t)},expression:"form.doorNumber"}})],1),e._v(" "),i("el-form-item",{attrs:{label:"设备编号",prop:"id"}},[i("el-input",{attrs:{placeholder:""},model:{value:e.form.id,callback:function(t){e.$set(e.form,"id",t)},expression:"form.id"}}),e._v(" "),i("QR")],1),e._v(" "),i("el-form-item",{attrs:{label:"安装地区",prop:"area"}},[i("span",{staticClass:"seletArea",on:{click:function(t){t.stopPropagation(),e.slctAddress(t)}}},[e._v(e._s(e.form.area))])]),e._v(" "),i("el-form-item",[i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.onSubmit("form")}}},[e._v("提交测试")])],1),e._v(" "),i("el-button",{staticClass:"showMore",attrs:{type:"text"},on:{click:e.showMore}},[e._v("更多信息"),i("i",{staticClass:"el-icon-arrow-right"})]),e._v(" "),i("div",{ref:"collectorMore",staticClass:"collectorMore"},[i("el-form-item",{attrs:{label:"挂接水表",prop:"wid"}},[i("el-input",{attrs:{placeholder:"无线采集器可挂接的水表编号"},model:{value:e.form.wid,callback:function(t){e.$set(e.form,"wid",t)},expression:"form.wid"}})],1),e._v(" "),i("el-form-item",{attrs:{label:"用户姓名"}},[i("el-input",{attrs:{placeholder:""},model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),e._v(" "),i("el-form-item",{attrs:{label:"联系电话"}},[i("el-input",{attrs:{placeholder:""},model:{value:e.form.phoneNumber,callback:function(t){e.$set(e.form,"phoneNumber",t)},expression:"form.phoneNumber"}})],1)],1)],1),e._v(" "),i("selectAddress",{ref:"slcAdress",attrs:{areaID:this.form},on:{areaConfirm:e.areaConfirm}}),e._v(" "),i("testResult",{ref:"testResult",attrs:{deviceNum:this.form.id}})],1)},staticRenderFns:[]};var $=i("VU/8")(y,w,!1,function(e){i("/K7l")},null,null);t.default=$.exports},puVE:function(e,t){}});
//# sourceMappingURL=10.be7ffdfd37b0440410c6.js.map